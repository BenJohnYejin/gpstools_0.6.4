/*------------------------------------------------------------------------------
% [system] : GpsTools
% [module] : eci to ecef transformation matrix
% [func]   : calculate eci to ecef transformation matrix
% [argin]  : tm = date/time (mjd-utc)
%            (erp_value)= earth rotation parameters (default:[0,0,0,0,0])
%                erpvalue(1:2) = pole offset xp,yp(rad)
%                erpvalue(3)   = ut1-utc(sec)
%                erpvalue(4:5) = nutation offset dpsi,deps(rad) (no use)
%            (utc_tai)  = utc-tai(sec) (default:-32)
%            (model_nut)= nutation model(no use)
% [argout] : U    = eci to ecef transformation matrix(3x3)
%            P,N  = precession,nutation matrix(3x3)
%            gmst = Greenwich mean sidereal time(rad)
%            (dUdxp,dUdyp,dUddt) = dU/dxp,dU/dyp,dU/d(UT1-UTC)(1/rad,1/rad,1/sec)
% [note]   : iau1976 precession,iau1980 nutation model
%            eci  : icrf (J2000.0 mean equator coordinate)
%            ecef : itrf
%            inv(U)=U',inv(P)=P',inv(N)=N'
% [version]: $Revision: 6 $ $Date: 06/07/08 1:01 $
%            Copyright(c) 2004-2006 by T.Takasu, all rights reserved
% [history]: 03/12/31  0.1  new
%            05/04/29  0.2  calculate dpsi,deps by KSV_1996_3.f
%-----------------------------------------------------------------------------*/
#include "qtcmn.h"
#include "mex.h"

/* precession/nutation -------------------------------------------------------*/
extern void KSV_1996_3(double *jd, double *dpsi_ls, double *deps_ls,
					   double *dpsi_plan, double *deps_plan, double *dpsi_fcn,
					   double *deps_fcn, double *dpsi_prec, double *deps_prec,
					   double *dpsi_tot, double *deps_tot);

/* partial derivatives of coordinate rotation matrixes -----------------------*/
#define dRxdt(t,X) \
{ \
	(X)[0]=(X)[1]=(X)[2]=(X)[3]=(X)[6]=0.0; \
	(X)[4]=(X)[8]=-sin(t); (X)[7]=cos(t); (X)[5]=-(X)[7]; \
}
#define dRydt(t,X) \
{ \
	(X)[1]=(X)[3]=(X)[4]=(X)[5]=(X)[7]=0.0; \
	(X)[0]=(X)[8]=-sin(t); (X)[2]=cos(t); (X)[6]=-(X)[2]; \
}
#define dRzdt(t,X) \
{ \
	(X)[2]=(X)[5]=(X)[6]=(X)[7]=(X)[8]=0.0; \
	(X)[0]=(X)[4]=-sin(t); (X)[3]=cos(t); (X)[1]=-(X)[3]; \
}
/* astronomical argument coefficients ----------------------------------------*/
static const double Fc[5][5]={
	{ 134.96340251, 1717915923.2178,  31.8792,  0.051635, -0.00024470},
	{ 357.52910918,  129596581.0481,  -0.5532,  0.000136, -0.00001149},
	{  93.27209062, 1739527262.8478, -12.7512, -0.001037,  0.00000417},
	{ 297.85019547, 1602961601.2090,  -6.3706,  0.006593, -0.00003169},
	{ 125.04455501,   -6962890.2665,   7.4722,  0.007702  -0.00005939}
};
/* iau1980 nutation coefficients ---------------------------------------------*/
static const double Nc[106][10]={
	{   0,   0,   0,   0,   1, -6798.4, -171996, -174.2, 92025,   8.9},
	{   0,   0,   2,  -2,   2,   182.6,  -13187,   -1.6,  5736,  -3.1},
	{   0,   0,   2,   0,   2,    13.7,   -2274,   -0.2,   977,  -0.5},
	{   0,   0,   0,   0,   2, -3399.2,    2062,    0.2,  -895,   0.5},
	{   0,  -1,   0,   0,   0,  -365.3,   -1426,    3.4,    54,  -0.1},
	{   1,   0,   0,   0,   0,    27.6,     712,    0.1,    -7,   0.0},
	{   0,   1,   2,  -2,   2,   121.7,    -517,    1.2,   224,  -0.6},
	{   0,   0,   2,   0,   1,    13.6,    -386,   -0.4,   200,   0.0},
	{   1,   0,   2,   0,   2,     9.1,    -301,    0.0,   129,  -0.1},
	{   0,  -1,   2,  -2,   2,   365.2,     217,   -0.5,   -95,   0.3},
	{  -1,   0,   0,   2,   0,    31.8,     158,    0.0,    -1,   0.0},
	{   0,   0,   2,  -2,   1,   177.8,     129,    0.1,   -70,   0.0},
	{  -1,   0,   2,   0,   2,    27.1,     123,    0.0,   -53,   0.0},
	{   1,   0,   0,   0,   1,    27.7,      63,    0.1,   -33,   0.0},
	{   0,   0,   0,   2,   0,    14.8,      63,    0.0,    -2,   0.0},
	{  -1,   0,   2,   2,   2,     9.6,     -59,    0.0,    26,   0.0},
	{  -1,   0,   0,   0,   1,   -27.4,     -58,   -0.1,    32,   0.0},
	{   1,   0,   2,   0,   1,     9.1,     -51,    0.0,    27,   0.0},
	{  -2,   0,   0,   2,   0,  -205.9,     -48,    0.0,     1,   0.0},
	{  -2,   0,   2,   0,   1,  1305.5,      46,    0.0,   -24,   0.0},
	{   0,   0,   2,   2,   2,     7.1,     -38,    0.0,    16,   0.0},
	{   2,   0,   2,   0,   2,     6.9,     -31,    0.0,    13,   0.0},
	{   2,   0,   0,   0,   0,    13.8,      29,    0.0,    -1,   0.0},
	{   1,   0,   2,  -2,   2,    23.9,      29,    0.0,   -12,   0.0},
	{   0,   0,   2,   0,   0,    13.6,      26,    0.0,    -1,   0.0},
	{   0,   0,   2,  -2,   0,   173.3,     -22,    0.0,     0,   0.0},
	{  -1,   0,   2,   0,   1,    27.0,      21,    0.0,   -10,   0.0},
	{   0,   2,   0,   0,   0,   182.6,      17,   -0.1,     0,   0.0},
	{   0,   2,   2,  -2,   2,    91.3,     -16,    0.1,     7,   0.0},
	{  -1,   0,   0,   2,   1,    32.0,      16,    0.0,    -8,   0.0},
	{   0,   1,   0,   0,   1,   386.0,     -15,    0.0,     9,   0.0},
	{   1,   0,   0,  -2,   1,   -31.7,     -13,    0.0,     7,   0.0},
	{   0,  -1,   0,   0,   1,  -346.6,     -12,    0.0,     6,   0.0},
	{   2,   0,  -2,   0,   0, -1095.2,      11,    0.0,     0,   0.0},
	{  -1,   0,   2,   2,   1,     9.5,     -10,    0.0,     5,   0.0},
	{   1,   0,   2,   2,   2,     5.6,      -8,    0.0,     3,   0.0},
	{   0,  -1,   2,   0,   2,    14.2,      -7,    0.0,     3,   0.0},
	{   0,   0,   2,   2,   1,     7.1,      -7,    0.0,     3,   0.0},
	{   1,   1,   0,  -2,   0,   -34.8,      -7,    0.0,     0,   0.0},
	{   0,   1,   2,   0,   2,    13.2,       7,    0.0,    -3,   0.0},
	{  -2,   0,   0,   2,   1,  -199.8,      -6,    0.0,     3,   0.0},
	{   0,   0,   0,   2,   1,    14.8,      -6,    0.0,     3,   0.0},
	{   2,   0,   2,  -2,   2,    12.8,       6,    0.0,    -3,   0.0},
	{   1,   0,   0,   2,   0,     9.6,       6,    0.0,     0,   0.0},
	{   1,   0,   2,  -2,   1,    23.9,       6,    0.0,    -3,   0.0},
	{   0,   0,   0,  -2,   1,   -14.7,      -5,    0.0,     3,   0.0},
	{   0,  -1,   2,  -2,   1,   346.6,      -5,    0.0,     3,   0.0},
	{   2,   0,   2,   0,   1,     6.9,      -5,    0.0,     3,   0.0},
	{   1,  -1,   0,   0,   0,    29.8,       5,    0.0,     0,   0.0},
	{   1,   0,   0,  -1,   0,   411.8,      -4,    0.0,     0,   0.0},
	{   0,   0,   0,   1,   0,    29.5,      -4,    0.0,     0,   0.0},
	{   0,   1,   0,  -2,   0,   -15.4,      -4,    0.0,     0,   0.0},
	{   1,   0,  -2,   0,   0,   -26.9,       4,    0.0,     0,   0.0},
	{   2,   0,   0,  -2,   1,   212.3,       4,    0.0,    -2,   0.0},
	{   0,   1,   2,  -2,   1,   119.6,       4,    0.0,    -2,   0.0},
	{   1,   1,   0,   0,   0,    25.6,      -3,    0.0,     0,   0.0},
	{   1,  -1,   0,  -1,   0, -3232.9,      -3,    0.0,     0,   0.0},
	{  -1,  -1,   2,   2,   2,     9.8,      -3,    0.0,     1,   0.0},
	{   0,  -1,   2,   2,   2,     7.2,      -3,    0.0,     1,   0.0},
	{   1,  -1,   2,   0,   2,     9.4,      -3,    0.0,     1,   0.0},
	{   3,   0,   2,   0,   2,     5.5,      -3,    0.0,     1,   0.0},
	{  -2,   0,   2,   0,   2,  1615.7,      -3,    0.0,     1,   0.0},
	{   1,   0,   2,   0,   0,     9.1,       3,    0.0,     0,   0.0},
	{  -1,   0,   2,   4,   2,     5.8,      -2,    0.0,     1,   0.0},
	{   1,   0,   0,   0,   2,    27.8,      -2,    0.0,     1,   0.0},
	{  -1,   0,   2,  -2,   1,   -32.6,      -2,    0.0,     1,   0.0},
	{   0,  -2,   2,  -2,   1,  6786.3,      -2,    0.0,     1,   0.0},
	{  -2,   0,   0,   0,   1,   -13.7,      -2,    0.0,     1,   0.0},
	{   2,   0,   0,   0,   1,    13.8,       2,    0.0,    -1,   0.0},
	{   3,   0,   0,   0,   0,     9.2,       2,    0.0,     0,   0.0},
	{   1,   1,   2,   0,   2,     8.9,       2,    0.0,    -1,   0.0},
	{   0,   0,   2,   1,   2,     9.3,       2,    0.0,    -1,   0.0},
	{   1,   0,   0,   2,   1,     9.6,      -1,    0.0,     0,   0.0},
	{   1,   0,   2,   2,   1,     5.6,      -1,    0.0,     1,   0.0},
	{   1,   1,   0,  -2,   1,   -34.7,      -1,    0.0,     0,   0.0},
	{   0,   1,   0,   2,   0,    14.2,      -1,    0.0,     0,   0.0},
	{   0,   1,   2,  -2,   0,   117.5,      -1,    0.0,     0,   0.0},
	{   0,   1,  -2,   2,   0,  -329.8,      -1,    0.0,     0,   0.0},
	{   1,   0,  -2,   2,   0,    23.8,      -1,    0.0,     0,   0.0},
	{   1,   0,  -2,  -2,   0,    -9.5,      -1,    0.0,     0,   0.0},
	{   1,   0,   2,  -2,   0,    32.8,      -1,    0.0,     0,   0.0},
	{   1,   0,   0,  -4,   0,   -10.1,      -1,    0.0,     0,   0.0},
	{   2,   0,   0,  -4,   0,   -15.9,      -1,    0.0,     0,   0.0},
	{   0,   0,   2,   4,   2,     4.8,      -1,    0.0,     0,   0.0},
	{   0,   0,   2,  -1,   2,    25.4,      -1,    0.0,     0,   0.0},
	{  -2,   0,   2,   4,   2,     7.3,      -1,    0.0,     1,   0.0},
	{   2,   0,   2,   2,   2,     4.7,      -1,    0.0,     0,   0.0},
	{   0,  -1,   2,   0,   1,    14.2,      -1,    0.0,     0,   0.0},
	{   0,   0,  -2,   0,   1,   -13.6,      -1,    0.0,     0,   0.0},
	{   0,   0,   4,  -2,   2,    12.7,       1,    0.0,     0,   0.0},
	{   0,   1,   0,   0,   2,   409.2,       1,    0.0,     0,   0.0},
	{   1,   1,   2,  -2,   2,    22.5,       1,    0.0,    -1,   0.0},
	{   3,   0,   2,  -2,   2,     8.7,       1,    0.0,     0,   0.0},
	{  -2,   0,   2,   2,   2,    14.6,       1,    0.0,    -1,   0.0},
	{  -1,   0,   0,   0,   2,   -27.3,       1,    0.0,    -1,   0.0},
	{   0,   0,  -2,   2,   1,  -169.0,       1,    0.0,     0,   0.0},
	{   0,   1,   2,   0,   1,    13.1,       1,    0.0,     0,   0.0},
	{  -1,   0,   4,   0,   2,     9.1,       1,    0.0,     0,   0.0},
	{   2,   1,   0,  -2,   0,   131.7,       1,    0.0,     0,   0.0},
	{   2,   0,   0,   2,   0,     7.1,       1,    0.0,     0,   0.0},
	{   2,   0,   2,  -2,   1,    12.8,       1,    0.0,    -1,   0.0},
	{   2,   0,  -2,   0,   1,  -943.2,       1,    0.0,     0,   0.0},
	{   1,  -1,   0,  -2,   0,   -29.3,       1,    0.0,     0,   0.0},
	{  -1,   0,   0,   1,   1,  -388.3,       1,    0.0,     0,   0.0},
	{  -1,  -1,   0,   2,   1,    35.0,       1,    0.0,     0,   0.0},
	{   0,   1,   0,   1,   0,    27.3,       1,    0.0,     0,   0.0}
};

/* iau1980 nutation ----------------------------------------------------------*/
static void iau1980(double t, double *f, double *dpsi, double *deps)
{
	int i,j;
	double args;
	
	for (i=0,*dpsi=*deps=0.0;i<106;i++) {
	  	for (j=0,args=0.0;j<5;j++) args+=Nc[i][j]*f[j];
		*dpsi+=(Nc[i][6]+Nc[i][7]*t)*sin(args);
		*deps+=(Nc[i][8]+Nc[i][9]*t)*cos(args);
	}
	*dpsi=*dpsi*1E-4*SEC2RAD;
	*deps=*deps*1E-4*SEC2RAD;
}
/* eci to ecef transformation matrix -----------------------------------------*/
extern void EcsfToEcef(const double *tm, const double *erp_value,
                       const double *utc_tai,const char *model_nut, double *U,
                       double *P, double *N, double *gmst, double *dUdxp,
                       double *dUdyp, double *dUddt, double *fargs)
{

	static const double erp_val_d[]={0.0,0.0,0.0,0.0,0.0},utc_tai_d[]={-32.0};
	int i;
	double tt,t,t2,t3,t4,eps,ze,th,z,dpsi,deps,tut,ut,tu,gmst0,gast;
	double f[5],RX[9],RY[9],RZ[9],R1[9],R2[9],R3[9],NP[9];
	double jd,dpls,dels,dppl,depl,dpfc,defc,dppr,depr,_dpsi,_deps;
	const double *erp_value_v,*utc_tai_v;

	if (erp_value==NULL) erp_value_v=erp_val_d; else erp_value_v=erp_value;
	if (utc_tai==NULL) utc_tai_v=utc_tai_d; else utc_tai_v=utc_tai;

	/* terrestrial time */
	tt=tm[0]+(32.184-utc_tai_v[0])/86400.0;
	
	/* precession */
	t=(tt-51544.5)/36525.0; t2=t*t; t3=t*t2; t4=t*t3;
	eps=(84381.448-46.8150*t-0.00059*t2+0.001813*t3)*SEC2RAD;
	ze=(2306.2181*t+0.30188*t2+0.017998*t3)*SEC2RAD;
	th=(2004.3109*t-0.42665*t2-0.041833*t3)*SEC2RAD;
	z=ze+(0.79280*t2+0.000205*t3)*SEC2RAD;
	Rz(-z,R1); Ry(th,R2); MM(R1,R2,R3);
	Rz(-ze,R1); MM(R3,R1,P);
	
	for (i=0;i<5;i++) {
		f[i]=MOD((Fc[i][0]*3600.0+Fc[i][1]*t+Fc[i][2]*t2+Fc[i][3]*t3+Fc[i][4]*t4)*
				 SEC2RAD,2.0*M_PI);
	}
	if (strcmp(model_nut,"iers1996")==0) {
		jd=tt+2400000.5;
		KSV_1996_3(&jd,&dpls,&dels,&dppl,&depl,&dpfc,&defc,&dppr,&depr,&dpsi,&deps);
		dpsi*=1E-3*SEC2RAD; deps*=1E-3*SEC2RAD;
	}
	else {
		iau1980(t,f,&dpsi,&deps); dpsi+=erp_value_v[3]; deps+=erp_value_v[4];
	}
	Rx(-eps-deps,R1); Rz(-dpsi,R2); MM(R1,R2,R3);
	Rx(eps,R1); MM(R3,R1,N);
	
	/* Greenwich sidereal time */
	tut=tm[0]+erp_value_v[2]/86400.0;
	ut=(tut-floor(tut))*86400.0;
	tu=(floor(tut)-51544.5)/36525; t2=tu*tu; t3=t2*tu;
	gmst0=24110.54841+8640184.812866*tu+1.002737909350795*ut+0.093104*t2-6.2E-6*t3;
	gmst[0]=MOD(gmst0,86400.0)*M_PI/43200.0;
	gast=gmst[0]+dpsi*cos(eps)+(0.00264*sin(f[4])+0.000063*sin(2.0*f[4]))*SEC2RAD;
	
	/* eci to ecef transformation matrix */
	MM(N,P,NP); Ry(-erp_value_v[0],RY); Rx(-erp_value_v[1],RX); MM(RY,RX,R1);
	Rz(gast,RZ); MM(R1,RZ,R2); MM(R2,NP,U);

	/* partial derivatives */
	if (dUdxp!=NULL) {
		dRydt(-erp_value_v[0],R1); MM(R1,RX,R2); MM(R2,RZ,R1); MM(R1,NP,dUdxp);
		for (i=0;i<9;i++) dUdxp[i]=-dUdxp[i];
	}
	if (dUdyp!=NULL) {
		dRxdt(-erp_value_v[1],R1); MM(RY,R1,R2); MM(R2,RZ,R1); MM(R1,NP,dUdyp);
		for (i=0;i<9;i++) dUdyp[i]=-dUdyp[i];
	}
	if (dUddt!=NULL) {
		MM(RY,RX,R1); dRzdt(gast,R2); MM(R1,R2,R3); MM(R3,NP,dUddt);
		for (i=0;i<9;i++) dUddt[i]*=1.002737909350795*M_PI/43200.0;
	}
	if (fargs!=NULL) for (i=0;i<5;i++) fargs[i]=f[i];
}
